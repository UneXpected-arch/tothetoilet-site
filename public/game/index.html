<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIPE: Catch The Gains</title>
<link rel="icon" href="/game/assets/favicon.png" type="image/png" />
<meta name="description" content="WIPE mini-game â€” catch coins with a toilet paper roll and post your score.">

<style>
  :root{
    --bg:#0E2341; --tile:#122b52; --accent:#1E4E89;
    --gold:#F6C445; --text:#F7F7F7;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh}

  /* HUD top */
  .hudbar{
    position:fixed;left:10px;top:10px;z-index:10;display:flex;gap:14px;align-items:center;font-weight:800;text-shadow:0 2px 5px rgba(0,0,0,.35)
  }
  .brand{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(30,78,137,.28);border:1px solid rgba(255,255,255,.12)}
  .brand img{width:18px;height:18px;border-radius:50%}

  /* Leaderboard mini bar */
  .lbbar{
    position:fixed;left:150px;top:8px;z-index:10;display:flex;gap:8px;align-items:center;background:rgba(14,35,65,.55);
    border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:12px;backdrop-filter:blur(2px)
  }
  .lbbar input{height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:#0e2341;color:#fff;padding:0 8px;outline:0}
  .lbbar button{height:28px;border-radius:8px;border:0;background:#2c6cca;color:#061b2c;font-weight:800;cursor:pointer;padding:0 10px}
  .lbbar .top{font-size:13px;opacity:.85}

  /* Start + Game Over panels */
  .center{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .panel{
    pointer-events:auto;background:rgba(14,35,65,.92);border:1px solid rgba(255,255,255,.12);
    border-radius:16px;padding:22px;max-width:780px;width:min(92%,780px);box-shadow:0 10px 40px rgba(0,0,0,.45)
  }
  .hero{height:150px;border-radius:12px;background:#081a33 url('/game/assets/start-panel.png') center/cover no-repeat;margin-bottom:16px;border:1px solid rgba(255,255,255,.08)}
  .h1{font-weight:900;font-size:clamp(18px,3.8vw,28px);margin:0 0 8px}
  .muted{opacity:.85}
  .actions{display:flex;gap:10px;margin-top:12px}
  .btn{border:0;border-radius:12px;padding:12px 18px;font-weight:900;cursor:pointer}
  .btn.primary{background:#2c6cca;color:#061b2c}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff}
  .credits{position:fixed;right:10px;bottom:8px;font-size:12px;opacity:.6}

  /* Backdrop image (full game) */
  .bgimg{
    position:fixed;inset:0;z-index:-1;background:#06172e url('/game/assets/background.png') center/cover no-repeat;
  }
  @media (max-width:700px){
    .lbbar{left:10px;top:52px}
  }
</style>
</head>
<body>
<div class="bgimg" id="bgimg"></div>
<canvas id="game"></canvas>

<!-- HUD -->
<div class="hudbar">
  <span class="brand"><img src="/game/assets/logo.png" alt=""><b>WIPE</b></span>
  <span id="hudScore">Score: 0</span>
  <span id="hudCombo">Combo: x1</span>
  <span id="hudLives">Lives: 3</span>
</div>

<!-- Leaderboard mini -->
<div class="lbbar">
  <b>Top Degens:</b>
  <span id="lbTop" class="top">loadingâ€¦</span>
  <input id="lbName" placeholder="your @name" maxlength="24">
  <button id="lbSave">Save</button>
</div>

<!-- START -->
<div id="startWrap" class="center">
  <div class="panel">
    <div class="hero"></div>
    <div class="h1">WIPE: Catch the Gains ðŸ’Ž</div>
    <div class="muted">Move the TP roll to <b>catch coins</b>. Miss 3 and itâ€™s <i>game over</i>.</div>
    <div class="actions">
      <button class="btn primary" id="startBtn">Start</button>
      <button class="btn ghost" id="muteBtn">Sound: Off</button>
    </div>
  </div>
</div>

<!-- GAME OVER -->
<div id="overWrap" class="center" style="display:none;">
  <div class="panel">
    <div class="h1">Flushedâ€¦ ðŸ’€</div>
    <div id="finalText" class="muted"></div>
    <div class="actions">
      <button class="btn primary" id="againBtn">Play Again</button>
      <button class="btn ghost" id="shareBtn">Share to X</button>
    </div>
  </div>
</div>

<div class="credits">WIPE mini-game</div>

<script>
(()=>{
  /* ----------------- canvas & helpers ----------------- */
  const cv = document.getElementById('game'), ctx = cv.getContext('2d');
  function fit(){ const dpr = Math.min(window.devicePixelRatio||1,2); cv.width = innerWidth*dpr; cv.height = innerHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
  addEventListener('resize', fit, {passive:true}); fit();

  const $score = document.getElementById('hudScore');
  const $combo = document.getElementById('hudCombo');
  const $lives = document.getElementById('hudLives');
  const $startWrap = document.getElementById('startWrap');
  const $overWrap = document.getElementById('overWrap');
  const $finalText = document.getElementById('finalText');
  const $startBtn = document.getElementById('startBtn');
  const $againBtn = document.getElementById('againBtn');
  const $muteBtn = document.getElementById('muteBtn');
  const $shareBtn = document.getElementById('shareBtn');
  const $lbTop = document.getElementById('lbTop');
  const $lbName = document.getElementById('lbName');
  const $lbSave = document.getElementById('lbSave');

  /* ----------------- assets ----------------- */
  const IMGS = {};
  function img(src){ return new Promise((res)=>{ const i=new Image(); i.onload=()=>res(i); i.src=src; }); }
  const ASSET = {
    bg1: '/game/assets/background.png',
    bg2: '/game/assets/backdrop.png',
    tp : '/game/assets/tp-roll.png',
    g  : '/game/assets/coin_gold.png',
    d  : '/game/assets/coin_diamond.png'
  };

  Promise.all([
    img(ASSET.bg1).catch(()=>null),
    img(ASSET.bg2).catch(()=>null),
    img(ASSET.tp),
    img(ASSET.g),
    img(ASSET.d)
  ]).then(([bg1,bg2,tp,g,d])=>{
    IMGS.bg = bg1 || bg2 || null; IMGS.tp = tp; IMGS.g = g; IMGS.d = d;
  });

  /* ----------------- audio toggle ----------------- */
  let soundOn = false, actx=null;
  function beep(freq=880, dur=70, vol=0.06){
    if(!soundOn) return;
    try{
      if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)();
      const t0=actx.currentTime, o=actx.createOscillator(), g=actx.createGain();
      o.type='square'; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g); g.connect(actx.destination);
      o.start(t0); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur/1000); o.stop(t0+dur/1000+.02);
    }catch{}
  }
  $muteBtn.onclick = ()=>{ soundOn=!soundOn; $muteBtn.textContent = 'Sound: '+(soundOn?'On':'Off'); if(soundOn) beep(660,60,0.03); };

  /* ----------------- game state ----------------- */
  const S = {
    running:false, over:false,
    score:0, combo:1, lives:3, best:0,
    speed:220, spawnRate:800, spawnTimer:0, coins:[],
    tp:{ x:innerWidth/2, y:innerHeight-90, w:200, h:52 },
    pops:[], parts:[]
  };

  function reset(){
    S.running=false; S.over=false;
    S.score=0; S.combo=1; S.lives=3; S.speed=220; S.spawnRate=800; S.spawnTimer=0;
    S.coins.length=0; S.pops.length=0; S.parts.length=0;
    S.tp.x = innerWidth/2;
    updateHUD();
  }
  function start(){
    reset(); S.running=true; $startWrap.style.display='none'; $overWrap.style.display='none';
    last = performance.now(); requestAnimationFrame(loop);
  }
  function endGame(){
    S.running=false; S.over=true;
    S.best = Math.max(S.best, S.score);
    $finalText.textContent = `Score: ${S.score} â€¢ Best: ${S.best}`;
    $overWrap.style.display='flex';
    document.dispatchEvent(new CustomEvent('wipe:gameover', { detail:{ score:S.score }}));
  }

  $startBtn.onclick = start; $againBtn.onclick = start;
  $shareBtn.onclick = ()=>{
    const u=new URL('https://twitter.com/intent/tweet');
    u.searchParams.set('text',`I scored ${S.score} in WIPE: Catch the Gains ðŸ§»ðŸ’° â€” can you beat me? #WIPEcoin`);
    u.searchParams.set('url', location.origin);
    window.open(u.toString(),'_blank');
  };

  /* ----------------- leaderboard (file-store API) ----------------- */
  async function loadScores(){
    try{ const r=await fetch('/api/scores'); return await r.json(); }catch{ return []; }
  }
  async function saveScore(name, score){
    try{ await fetch('/api/scores',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,score})}); }catch{}
  }
  function renderTop(scores){
    if(!scores || !scores.length){ $lbTop.textContent='â€”'; return; }
    $lbTop.textContent = scores.slice(0,5).map(s=>`${s.name}:${s.score}`).join(' Â· ');
  }
  loadScores().then(renderTop);
  document.addEventListener('wipe:gameover', async e=>{
    const name = ($lbName.value||'anon').slice(0,24);
    await saveScore(name, e.detail.score);
    const s=await loadScores(); renderTop(s);
  });
  $lbSave.onclick = async ()=>{
    await saveScore(($lbName.value||'anon').slice(0,24), S.score);
    const s=await loadScores(); renderTop(s);
  };

  /* ----------------- input ----------------- */
  let dragging=false, dx=0;
  cv.addEventListener('pointerdown', e=>{dragging=true; dx = e.clientX - S.tp.x;});
  addEventListener('pointerup', ()=>dragging=false);
  addEventListener('pointermove', e=>{ if(!dragging) return; S.tp.x = clamp(e.clientX - dx, S.tp.w/2, innerWidth - S.tp.w/2); }, {passive:true});
  const keys={}; addEventListener('keydown',e=>keys[e.key]=true); addEventListener('keyup',e=>keys[e.key]=false);

  /* ----------------- helpers & visuals ----------------- */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand =(a,b)=>Math.random()*(b-a)+a;

  function drawTP(tp){
    const {x,y,w,h}=tp;
    const img = IMGS.tp;
    if(img){ const r=h/img.height; ctx.drawImage(img, x-w/2, y-h/2, w, h); }
    else{
      // fallback styled capsule
      ctx.fillStyle='#f1f4f8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.roundRect(x-w/2,y-h/2,w,h,18); ctx.fill(); ctx.stroke();
      ctx.fillStyle='rgba(30,78,137,.70)'; ctx.font='900 18px system-ui'; ctx.textAlign='center'; ctx.fillText('WIPE',x,y+6);
    }
  }

  function drawCoin(c){
    ctx.save(); ctx.translate(c.x,c.y);
    ctx.rotate(c.rot);
    const img = (c.type==='diamond') ? IMGS.d : IMGS.g;
    if(img){
      const d = c.r*2; ctx.drawImage(img, -c.r, -c.r, d, d);
    }else{
      ctx.fillStyle = c.type==='diamond' ? '#9fe0ff' : '#ffd76a';
      ctx.beginPath(); ctx.arc(0,0,c.r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#083b5a'; ctx.font='bold 14px system-ui'; ctx.textAlign='center'; ctx.fillText(c.type==='diamond'?'â™¦':'$',0,5);
    }
    ctx.restore();
  }

  function spawnCoin(){
    const rare = Math.random()<0.12;
    S.coins.push({
      x:rand(40, innerWidth-40), y:-30, r: rare?24:18,
      v:S.speed*(rare?.95:1), type: rare?'diamond':'gold', rot:rand(0,Math.PI*2)
    });
  }

  /* particles (sparkles) */
  function spawnSpark(x,y,clr){
    for(let i=0;i<16;i++){
      S.parts.push({ x, y, vx:rand(-2,2), vy:rand(-2,-0.5), a:1, clr:clr||'#ffd76a' });
    }
  }
  function drawParticles(){
    for(let i=S.parts.length-1;i>=0;i--){
      const p=S.parts[i]; p.x+=p.vx; p.y+=p.vy; p.a-=0.04;
      if(p.a<=0){ S.parts.splice(i,1); continue; }
      ctx.globalAlpha = Math.max(0,p.a);
      ctx.fillStyle = p.clr; ctx.fillRect(p.x,p.y,2,2); ctx.globalAlpha=1;
    }
  }

  /* popup text via particles layer */
  function popup(x,y,str,clr){
    S.pops.push({ text:str, x, y, up:0, a:1, clr:clr||'#fff' });
  }
  function drawPopups(){
    for(let i=S.pops.length-1;i>=0;i--){
      const p=S.pops[i]; p.up+=0.8; p.a-=0.02;
      if(p.a<=0){ S.pops.splice(i,1); continue; }
      ctx.globalAlpha = Math.max(0,p.a);
      ctx.fillStyle = p.clr; ctx.font='bold 16px system-ui'; ctx.textAlign='center';
      ctx.fillText(p.text, p.x, p.y - p.up);
      ctx.globalAlpha = 1;
    }
  }

  /* collision with bigger mobile padding */
  const CATCH_PAD = 10;
  function collide(c,tp){
    const cx = clamp(c.x, tp.x-tp.w/2-CATCH_PAD, tp.x+tp.w/2+CATCH_PAD);
    const cy = clamp(c.y, tp.y-tp.h/2-CATCH_PAD, tp.y+tp.h/2+CATCH_PAD);
    const dx = c.x-cx, dy = c.y-cy;
    return dx*dx + dy*dy <= c.r*c.r;
  }

  function updateHUD(){
    $score.textContent = `Score: ${S.score}`;
    $combo.textContent = `Combo: x${S.combo}`;
    $lives.textContent = `Lives: ${S.lives}`;
  }

  /* ----------------- main loop ----------------- */
  let last=0;
  function loop(t){
    if(!S.running) return;
    const dt = Math.min(32, t-last)/1000; last=t;

    // bg
    if(IMGS.bg){ ctx.drawImage(IMGS.bg, 0, 0, innerWidth, innerHeight); }
    else{
      ctx.fillStyle='#0b1e3a'; ctx.fillRect(0,0,innerWidth,innerHeight);
    }

    // TP control
    if(keys['ArrowLeft']||keys['a'])  S.tp.x -= 420*dt;
    if(keys['ArrowRight']||keys['d']) S.tp.x += 420*dt;
    S.tp.x = clamp(S.tp.x, S.tp.w/2, innerWidth - S.tp.w/2);

    // difficulty
    S.speed     += dt*6;
    S.spawnRate  = Math.max(260, S.spawnRate - dt*8);
    S.spawnTimer += dt*1000;
    if(S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawnCoin(); }

    // coins
    for(let i=S.coins.length-1;i>=0;i--){
      const c=S.coins[i];
      c.y += c.v*dt; c.rot += (c.type==='diamond'?2.1:1.4)*dt;

      if(collide(c,S.tp)){
        const gained = (c.type==='diamond'?100:10)*S.combo;
        S.score += gained; S.combo = Math.min(10, S.combo+1);
        popup(c.x, c.y-16, `+${gained}`, c.type==='diamond'? '#7fd1ff':'#ffe08a');
        spawnSpark(c.x, c.y, c.type==='diamond'? '#7fd1ff':'#ffd76a');
        beep(c.type==='diamond'?1040:820,70);
        S.coins.splice(i,1);
      }else if(c.y - c.r > innerHeight){
        S.lives--; S.combo=1; popup(c.x, c.y, 'miss', '#ff9aa2'); beep(220,120);
        S.coins.splice(i,1); if(S.lives<=0) { updateHUD(); endGame(); return; }
      }
    }

    // draw everything
    for(const c of S.coins) drawCoin(c);
    drawTP(S.tp);
    drawParticles();
    drawPopups();
    updateHUD();

    requestAnimationFrame(loop);
  }
})();
</script>
</body>
</html>
