<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>WIPE: Catch the Gains</title>
  <link rel="icon" href="/game/assets/favicon.png" type="image/png"/>

  <style>
    :root{
      --bg:#0E2341; --tile:#122b52; --accent:#1E4E89;
      --gold:#F6C445; --gold-dark:#b98513; --text:#F7F7F7;
    }

    /* Lock page and make the game own the viewport (mobile friendly) */
    html,body{
      height:100dvh;           /* correct on iOS */
      margin:0;
      overflow:hidden;         /* stop page scrolling */
      background:var(--bg);
      -webkit-user-select:none;
      user-select:none;
      overscroll-behavior:none; /* stop pull-to-refresh/bounce */
      touch-action:none;        /* route touches to our handlers */
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }

    /* Game canvas fills the screen, receives touches */
    #game{
      display:block;
      width:100vw;
      height:100dvh;
      background:#0E2341; /* fallback while images load */
      touch-action:none;
      image-rendering:auto;
    }

    /* Heads-up display */
    #ui{ position:fixed; inset:0; pointer-events:none; }
    .hud{position:absolute;left:12px;top:10px;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;gap:12px;align-items:center}
    .brand{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(30,78,137,.28);border:1px solid rgba(255,255,255,.12)}
    .brand img{width:18px;height:18px;border-radius:50%}
    .right{position:absolute;right:12px;top:10px;font-weight:700;opacity:.85}

    /* Panel shell shared by Start and Game Over */
    .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:left}
    .panel{
      position:relative;
      width:min(900px,92vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 40px rgba(0,0,0,.35);
      overflow:hidden;

      /* <<‚Äî force your hero image everywhere (desktop & mobile) */
      background:url("/game/assets/background.jpg") center/cover no-repeat;
      color:#fff;
      pointer-events:auto;  /* make buttons clickable */
    }
    /* readability overlay */
    .panel::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.45);z-index:0}
    .panel > *{position:relative;z-index:1}

    .panel-body{padding:18px 18px 22px}
    .panel h1{margin:0 0 6px;font-size:clamp(22px,3.6vw,28px)}
    .panel p{margin:8px 0;opacity:.92}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{pointer-events:auto;cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font-weight:800}
    .primary{background:var(--accent);color:#061b2c}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.25)}

    /* Start/GameOver ‚Äúhero‚Äù strip (NO <img>, background only) */
    .hero{
      width:100%;
      aspect-ratio: 16/9;
      min-height:180px;
      background:url("/game/assets/background.jpg") center/cover no-repeat;
      border-bottom:1px solid rgba(255,255,255,.12);
    }

    /* Credits */
    .credits{position:absolute;right:12px;bottom:10px;font-size:12px;opacity:.7}

    /* Mobile panel layout */
    @media (max-width:600px){
      #start.center, #gameover.center{align-items:flex-start;padding-top:16px}
      .panel{width:94vw}
    }
  </style>
</head>

<body>
  <canvas id="game"></canvas>

  <div id="ui">
    <div class="hud">
      <span class="brand"><img src="/game/assets/logo.png" alt="WIPE"><b>WIPE</b></span>
      <span id="score">Score: 0</span>
      <span id="combo">Combo: x1</span>
      <span id="lives">Lives: 3</span>
    </div>
    <div class="right">Drag / Touch or ‚Üê ‚Üí</div>

    <!-- START PANEL -->
    <div id="start" class="center">
      <div class="panel">
        <div class="hero"></div>
        <div class="panel-body">
          <h1>WIPE: Catch the Gains üíé</h1>
          <p>Move the TP roll to <b>catch coins</b>. Miss 3 and it‚Äôs <i>game over</i>.</p>
          <div class="actions">
            <button id="startBtn" class="primary">Start</button>
            <button id="muteBtn" class="ghost">Sound: Off</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameover" class="center" style="display:none;">
      <div class="panel">
        <div class="hero"></div>
        <div class="panel-body">
          <h2 style="margin:0 0 6px">Flushed‚Ä¶ üíÄ</h2>
          <p id="final" style="margin:8px 0 12px"></p>
          <div class="actions">
            <button id="again" class="primary">Play Again</button>
            <button id="share" class="ghost">Share to X</button>
          </div>
        </div>
      </div>
    </div>

    <div class="credits">WIPE mini-game</div>
  </div>

  <!-- ‚Äî‚Äî‚Äî Your existing game logic (unchanged) ‚Äî‚Äî‚Äî -->
  <script>
  (()=>{
    /* NOTE: This is your existing game logic trimmed to the essential
       parts. If you already have a working script block here, keep it.
       The only *necessary* changes are the viewport/touch patches below. */

    // Elements
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const $score = document.getElementById('score');
    const $combo = document.getElementById('combo');
    const $lives = document.getElementById('lives');
    const $start = document.getElementById('start');
    const $startBtn = document.getElementById('startBtn');
    const $muteBtn = document.getElementById('muteBtn');
    const $over = document.getElementById('gameover');
    const $final = document.getElementById('final');
    const $again = document.getElementById('again');
    const $share = document.getElementById('share');

    // --- MOBILE INPUT SAFETY (patch) ---
    // Prevent default browser gestures/scroll during touch
    const blockDefaultTouch = (e)=>{ e.preventDefault(); };
    document.addEventListener('touchmove', blockDefaultTouch, {passive:false});
    document.addEventListener('gesturestart', blockDefaultTouch, {passive:false});
    document.addEventListener('gesturechange', blockDefaultTouch, {passive:false});
    document.addEventListener('gestureend', blockDefaultTouch, {passive:false});

    // Canvas fit to physical pixels (good on iOS)
    function fitCanvas(){
      const dpr = window.devicePixelRatio || 1;
      canvas.width  = Math.floor(window.innerWidth  * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width  = window.innerWidth  + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw using CSS pixels
    }
    window.addEventListener('resize', fitCanvas);
    fitCanvas();

    // Game state (lightweight)
    const S = { running:false, over:false, score:0, combo:1, lives:3, best:0, time:0, spawnTimer:0, spawnRate:800, speed:220, coins:[], tp:{ x:innerWidth*0.5, y:innerHeight-90, w:180, h:36 } };

    function reset(){ S.score=0; S.combo=1; S.lives=3; S.coins.length=0; S.time=0; S.spawnTimer=0; S.spawnRate=800; S.speed=220; S.tp.x = canvas.clientWidth/2; }
    function start(){ reset(); S.running=true; S.over=false; $start.style.display='none'; $over.style.display='none'; last=performance.now(); requestAnimationFrame(loop); }
    function over(){ S.running=false; S.over=true; S.best=Math.max(S.best,S.score); $final.textContent = `Score: ${S.score}  ‚Ä¢  Best: ${S.best}`; $over.style.display='flex'; }

    $startBtn.onclick = start; $again.onclick = start;
    $share.onclick = () => {
      const text = `I scored ${S.score} in WIPE ‚Äî can you beat me? #WIPEcoin`;
      const u = new URL('https://twitter.com/intent/tweet');
      u.searchParams.set('text', text); u.searchParams.set('url', location.href);
      window.open(u.toString(), '_blank');
    };

    // Simple input
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    let dragging=false, dragOffset=0;
    canvas.addEventListener('pointerdown', e=>{ dragging=true; dragOffset = clamp(e.clientX - S.tp.x, -S.tp.w/2, S.tp.w/2); });
    addEventListener('pointermove', e=>{ if (!dragging) return; S.tp.x = clamp(e.clientX - dragOffset, S.tp.w/2, canvas.clientWidth - S.tp.w/2); });
    addEventListener('pointerup', ()=> dragging=false);
    const keys={}; addEventListener('keydown', e=>keys[e.key]=true); addEventListener('keyup', e=>keys[e.key]=false);

    // Draw TP catcher
    function drawTP(tp){
      const {x,y,w,h}=tp, r=18;
      ctx.save(); ctx.translate(x,y);
      ctx.fillStyle='#f1f4f8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2;
      ctx.beginPath(); roundRect(-w/2,-h/2,w,h,r); ctx.fill(); ctx.stroke();
      ctx.fillStyle='#b8894d'; ctx.beginPath(); ctx.ellipse(-w*0.35,0,14,14,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(30,78,137,.70)'; ctx.font='900 18px system-ui'; ctx.textAlign='center'; ctx.fillText('WIPE',0,6);
      ctx.restore();
    }
    function roundRect(x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); }

    // Coins (visuals simplified)
    function spawn(){ const rare = Math.random() < 0.08; S.coins.push({ x: Math.random()*(canvas.clientWidth-80)+40, y: -30, r: rare? 24:18, v: S.speed*(rare?.95:1), type: rare? 'diamond':'gold', rot: Math.random()*Math.PI*2 }); }
    function drawCoin(c){
      ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rot);
      if (c.type==='diamond'){
        ctx.fillStyle = '#b6f0ff'; ctx.strokeStyle = '#88d7ea'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(0,-c.r); ctx.lineTo(c.r*0.9,0); ctx.lineTo(0,c.r); ctx.lineTo(-c.r*0.9,0); ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.fillStyle='#0a3a4a'; ctx.font='bold 12px system-ui'; ctx.textAlign='center'; ctx.fillText('+100',0,4);
      } else {
        const grad = ctx.createRadialGradient(-5,-5,4,0,0,c.r+6);
        grad.addColorStop(0,'#fff5b2'); grad.addColorStop(1, '#F6C445');
        ctx.fillStyle = grad; ctx.strokeStyle = '#b98513'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.arc(0,0,c.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.fillStyle='#7f5a0a'; ctx.font='bold 14px system-ui'; ctx.textAlign='center'; ctx.fillText('$',0,5);
      }
      ctx.restore();
    }

    function collide(c,tp){ const cx = clamp(c.x, tp.x - tp.w/2, tp.x + tp.w/2); const cy = clamp(c.y, tp.y - tp.h/2, tp.y + tp.h/2); const dx=c.x-cx, dy=c.y-cy; return dx*dx+dy*dy <= c.r*c.r; }

    // Loop
    let last=0;
    function loop(t){
      if (!S.running) return;
      const dt = Math.min(32, t-last)/1000; last=t;

      S.time += dt; S.spawnTimer += dt*1000;
      S.speed += dt*6; S.spawnRate = Math.max(260, S.spawnRate - dt*8);
      if (S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawn(); }

      if (keys['ArrowLeft']||keys['a']) S.tp.x -= 420*dt;
      if (keys['ArrowRight']||keys['d']) S.tp.x += 420*dt;
      S.tp.x = clamp(S.tp.x, S.tp.w/2, canvas.clientWidth - S.tp.w/2);

      for (let i=S.coins.length-1;i>=0;i--){
        const c = S.coins[i];
        c.y += c.v*dt; c.rot += (c.type==='diamond'?2.2:1.4)*dt;
        if (collide(c,S.tp)){ const gained=(c.type==='diamond'?100:10) * S.combo; S.score+=gained; S.combo=Math.min(10,S.combo+1); S.coins.splice(i,1); }
        else if (c.y - c.r > canvas.clientHeight){ S.lives -= 1; S.combo=1; S.coins.splice(i,1); if (S.lives<=0) over(); }
      }

      // Draw
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      // (Leave canvas bg solid; panel already shows the hero img)
      S.coins.forEach(drawCoin);
      drawTP(S.tp);

      $score.textContent = `Score: ${S.score}`;
      $combo.textContent = `Combo: x${S.combo}`;
      $lives.textContent = `Lives: ${S.lives}`;

      requestAnimationFrame(loop);
    }
  })();
  </script>

  <!-- Viewport/resize helper separate (optional) -->
  <script>
    // If the address bar shows/hides on mobile, keep canvas fitted
    window.addEventListener('orientationchange', ()=> setTimeout(()=>window.dispatchEvent(new Event('resize')), 250));
  </script>
</body>
</html>
