<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIPE: Catch The Gains</title>
<meta name="description" content="WIPE mini-game â€” catch coins with a toilet paper roll and post your score.">
<link rel="icon" href="assets/favicon.png" type="image/png">
<meta property="og:title" content="WIPE: Catch The Gains">
<meta property="og:description" content="I scored big in WIPE â€” can you beat me?">
<meta property="og:image" content="assets/backdrop.jpg">
<link rel="stylesheet" href="/game/leaderboard.css">
<style>
  /* your original styles */
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">
  <div class="hud">
    <span class="brand"><img src="assets/logo.png" alt=""><b>WIPE</b></span>
    <span id="score">Score: 0</span>
    <span id="combo">Combo: x1</span>
    <span id="lives">Lives: 3</span>
    <span id="level-label"></span>
  </div>
  <div class="right">Drag / Touch or â† â†’</div>

  <div id="start" class="center">
    <div class="panel">
      <div class="backdrop"></div>
      <h1>WIPE: Catch the Gains ğŸ§»ğŸ’°</h1>
      <p>Move the TP roll to <b>catch coins</b>. Miss 3 and itâ€™s <i>game over</i>.</p>
      <div class="actions">
        <button id="startBtn" class="primary">Start</button>
        <button id="muteBtn" class="ghost">Sound: Off</button>
      </div>
    </div>
  </div>

  <div id="gameover" class="center" style="display:none;">
    <div class="panel">
      <div class="backdrop" style="filter:blur(1px) brightness(.85)"></div>
      <h2>Flushedâ€¦ ğŸ’€</h2>
      <p id="final"></p>
      <div class="actions">
        <button id="again" class="primary">Play Again</button>
        <button id="share" class="ghost">Share to X</button>
      </div>
    </div>
  </div>

  <div class="credits">WIPE mini-game</div>
</div>

<div id="wipe-leader"></div>

<script>
(()=>{
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const $score = document.getElementById('score');
  const $combo = document.getElementById('combo');
  const $lives = document.getElementById('lives');
  const $levelLabel = document.getElementById('level-label');
  const $start = document.getElementById('start');
  const $startBtn = document.getElementById('startBtn');
  const $muteBtn = document.getElementById('muteBtn');
  const $over = document.getElementById('gameover');
  const $final = document.getElementById('final');
  const $again = document.getElementById('again');
  const $share = document.getElementById('share');

  const levels = [
    "2022 Luna Crash Toilet",
    "FOMO Flush",
    "Rug Pull Flood"
  ];

  let currentLevel = 0;

  const C = { bg:'#0E2341', tile:'#122b52', accent:'#1E4E89', gold:'#F6C445', goldDark:'#b98513', text:'#F7F7F7' };

  // sound
  let soundOn = false; let audioCtx = null;
  function beep(freq=880, dur=80, vol=0.06) {
    if (!soundOn) return;
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = freq;
      g.gain.value = vol; o.connect(g); g.connect(audioCtx.destination);
      o.start(t0); g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000); o.stop(t0 + dur/1000 + 0.01);
    } catch {}
  }
  $muteBtn.onclick = () => { soundOn = !soundOn; $muteBtn.textContent = 'Sound: ' + (soundOn ? 'On':'Off'); if (soundOn) beep(660,60,0.03); };

  const rand = (a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function fit(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', fit, {passive:true}); fit();

  const S = { running:false, over:false, score:0, combo:1, lives:3, best:0, time:0, spawnTimer:0, spawnRate:800, speed:220, coins:[], tp:{ x:innerWidth*0.5, y:innerHeight-90, w:180, h:36 } };

  function reset(){
    S.score=0; S.combo=1; S.lives=3; S.coins.length=0; S.time=0; S.spawnTimer=0; S.spawnRate=800; S.speed=220; S.tp.x = canvas.width/2;
    currentLevel = 0;
    $levelLabel.textContent = levels[currentLevel];
  }
  function start(){
    reset();
    S.running=true; S.over=false;
    $start.style.display='none';
    $over.style.display='none';
    last=performance.now();
    requestAnimationFrame(loop);
  }
  function over(){
    S.running=false; S.over=true;
    S.best=Math.max(S.best,S.score);
    $final.textContent = `Score: ${S.score}  â€¢  Best: ${S.best}`;
    $over.style.display='flex';
    updateLeaderboard(S.score); // leaderboard hook
  }

  $startBtn.onclick = start; $again.onclick = start;
  $share.onclick = () => {
    const text = `I scored ${S.score} in WIPE: Catch the Gains ğŸ§»ğŸ’° â€” can you beat me? #WIPEcoin`;
    const url = location.href;
    const u = new URL('https://twitter.com/intent/tweet');
    u.searchParams.set('text', text); u.searchParams.set('url', url);
    window.open(u.toString(), '_blank');
  };

  // input
  let dragging=false, dragOffset=0;
  canvas.addEventListener('pointerdown', e=>{ dragging=true; dragOffset = clamp(e.clientX - S.tp.x, -S.tp.w/2, S.tp.w/2); });
  addEventListener('pointermove', e=>{ if (!dragging) return; S.tp.x = clamp(e.clientX - dragOffset, S.tp.w/2, canvas.width - S.tp.w/2); });
  addEventListener('pointerup', ()=> dragging=false);
  const keys={}; addEventListener('keydown', e=>keys[e.key]=true); addEventListener('keyup', e=>keys[e.key]=false);

  function spawn(){ const rare = Math.random() < 0.08; S.coins.push({ x: rand(40, canvas.width-40), y: -30, r: rare? 24:18, v: S.speed*(rare?.95:1), type: rare? 'diamond':'gold', rot: rand(0, Math.PI*2) }); }
  function collide(c,tp){ const cx = clamp(c.x, tp.x - tp.w/2, tp.x + tp.w/2); const cy = clamp(c.y, tp.y - tp.h/2, tp.y + tp.h/2); const dx=c.x-cx, dy=c.y-cy; return dx*dx+dy*dy <= c.r*c.r; }

  function drawTP(tp){ /* unchanged */ }
  function drawCoin(c){ /* unchanged */ }

  let last=0;
  function loop(t){
    if (!S.running) return;
    const dt = Math.min(32, t-last)/1000; last=t;
    S.time += dt; S.spawnTimer += dt*1000;
    S.speed += dt*6; S.spawnRate = Math.max(260, S.spawnRate - dt*8);

    // level progression
    if (S.score > 300 && currentLevel === 0) { currentLevel = 1; $levelLabel.textContent = levels[currentLevel]; triggerMemeEffect("Level Up: FOMO Flush! ğŸš½"); }
    if (S.score > 600 && currentLevel === 1) { currentLevel = 2; $levelLabel.textContent = levels[currentLevel]; triggerMemeEffect("Level Up: Rug Pull Flood! ğŸ’¦"); }

    if (S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawn(); }
    if (keys['ArrowLeft']||keys['a']) S.tp.x -= 420*dt;
    if (keys['ArrowRight']||keys['d']) S.tp.x += 420*dt;
    S.tp.x = clamp(S.tp.x, S.tp.w/2, canvas.width - S.tp.w/2);
    for (let i=S.coins.length-1;i>=0;i--){
      const c = S.coins[i];
      c.y += c.v*dt; c.rot += (c.type==='diamond'?2.2:1.4)*dt;
      if (collide(c,S.tp)){
        const gained=(c.type==='diamond'?100:10) * S.combo;
        S.score+=gained;
        triggerMemeEffect("+ " + gained + " ğŸ’°"); // meme effect hook
        S.combo=Math.min(10,S.combo+1);
        if (soundOn) beep(c.type==='diamond'?1040:820,70);
        S.coins.splice(i,1);
      }
      else if (c.y - c.r > canvas.height){
        S.lives -= 1; S.combo=1; S.coins.splice(i,1);
        if (soundOn) beep(220,120);
        if (S.lives<=0) over();
      }
    }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    S.coins.forEach(drawCoin); drawTP(S.tp);
    $score.textContent = `Score: ${S.score}`;
    $combo.textContent = `Combo: x${S.combo}`;
    $lives.textContent = `Lives: ${S.lives}`;
    requestAnimationFrame(loop);
  }
})();
</script>

<script src="/game/js/leaderboard.js"></script>
<script src="/game/js/effects.js"></script>
</body>
</html>
