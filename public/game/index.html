<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WIPE: Catch The Gains</title>
  <meta name="description" content="WIPE mini-game ‚Äî catch coins with a toilet paper roll and post your score.">

  <!-- Favicon (avoid 404) -->
  <link rel="icon" type="image/png" href="/game/assets/favicon.png" />

  <!-- HUD/board css (correct path) -->
  <link rel="stylesheet" href="/game/js/leaderboard.css">

  <style>
    :root {
      --bg:#0E2341; --tile:#122b52; --accent:#1E4E89;
      --gold:#F6C445; --gold-dark:#b98513; --text:#F7F7F7;
    }
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text)}
    #ui{position:fixed;inset:0;pointer-events:none}
    .hud{position:absolute;left:12px;top:10px;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;gap:12px;align-items:center}
    .brand{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(30,78,137,.28);border:1px solid rgba(255,255,255,.12)}
    .brand img{width:18px;height:18px;border-radius:50%}
    .right{position:absolute;right:12px;top:10px;font-weight:700;opacity:.85}
    .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    .panel{pointer-events:auto;background:rgba(14,35,65,.92);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:20px;max-width:560px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .panel h1{margin:0 0 8px}
    .panel p{margin:8px 0}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    button{pointer-events:auto;cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font-weight:800}
    .primary{background:var(--accent);color:#061b2c}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.25)}
    .muted{opacity:.8}
    canvas{display:block;width:100%;height:100vh;image-rendering:pixelated;background:#000;}
    .credits{position:absolute;right:12px;bottom:10px;font-size:12px;opacity:.7}

    /* Start panel artwork area */
    .art {
      width: 520px; height: 180px; border-radius:12px;
      background: radial-gradient(1200px 600px at 50% -10%, #1c396b 0%, var(--bg) 60%);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
      margin-bottom: 12px;
    }
    .art img {max-width:100%; max-height:100%; display:block;}
  </style>
</head>
<body>
<canvas id="game"></canvas>

<div id="ui">
  <div class="hud">
    <span class="brand">
      <img src="/game/assets/logo.png" alt="WIPE">
      <b>WIPE</b>
    </span>
    <span id="score">Score: 0</span>
    <span id="combo">Combo: x1</span>
    <span id="lives">Lives: 3</span>
  </div>
  <div class="right">Drag / Touch or ‚Üê ‚Üí</div>

  <div id="start" class="center">
    <div class="panel">
      <div class="art">
        <!-- use start-panel if present, else diamond background, else background -->
        <img id="startArt" alt="WIPE start">
      </div>
      <h1>WIPE: Catch the Gains üßªüí∞</h1>
      <p>Move the TP roll to <b>catch coins</b>. Miss 3 and it‚Äôs <i>game over</i>.</p>
      <div class="actions">
        <button id="startBtn" class="primary">Start</button>
        <button id="muteBtn" class="ghost">Sound: Off</button>
      </div>
    </div>
  </div>

  <div id="gameover" class="center" style="display:none;">
    <div class="panel">
      <h2>Flushed‚Ä¶ üíÄ</h2>
      <p id="final"></p>
      <div class="actions">
        <button id="again" class="primary">Play Again</button>
        <button id="share" class="ghost">Share to X</button>
      </div>
    </div>
  </div>

  <div class="credits">WIPE mini-game</div>
</div>

<script>
/* ---------- ASSET BASE (FIXED PATHS) ---------- */
const ASSETS_BASE = '/game/assets/';  // <-- everything loads from here

const IMG = {
  background:   ASSETS_BASE + 'background.png',
  diamondBg:    ASSETS_BASE + 'diamond background.png',
  startPanel:   ASSETS_BASE + 'start-panel.png',
  tp:           ASSETS_BASE + 'tp-roll.png',
  coinGold:     ASSETS_BASE + 'coin_gold.png',
  coinDiamond:  ASSETS_BASE + 'coin_diamond.png',
  logo:         ASSETS_BASE + 'logo.png',
  favicon:      ASSETS_BASE + 'favicon.png',
};

/* pick first available from a list */
function pickFirstAvailable(urls, cb){
  (function tryNext(i){
    if(i>=urls.length){ cb(null); return; }
    const img = new Image();
    img.onload = ()=>cb(urls[i]);
    img.onerror = ()=>tryNext(i+1);
    img.src = urls[i] + (urls[i].includes('?')? '&':'?') + 'v=' + Date.now();
  })(0);
}

/* ---------- SIMPLE GAME (unchanged logic, cleaned for CSP) ---------- */
(()=>{
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const $score = document.getElementById('score');
  const $combo = document.getElementById('combo');
  const $lives = document.getElementById('lives');

  const $start = document.getElementById('start');
  const $startBtn = document.getElementById('startBtn');
  const $muteBtn = document.getElementById('muteBtn');
  const $over = document.getElementById('gameover');
  const $final = document.getElementById('final');
  const $again = document.getElementById('again');
  const $share = document.getElementById('share');
  const $startArt = document.getElementById('startArt');

  let bgImage = null, tpImage = null, coinGold = null, coinDiamond = null;

  // set start artwork (first that exists)
  pickFirstAvailable([IMG.startPanel, IMG.diamondBg, IMG.background], (url)=>{
    if(url) $startArt.src = url;
  });

  // preload critical game artwork from /game/assets
  function preload(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
  async function preloadAll(){
    [bgImage, tpImage, coinGold, coinDiamond] = await Promise.all([
      preload(IMG.background),
      preload(IMG.tp),
      preload(IMG.coinGold),
      preload(IMG.coinDiamond)
    ]);
  }

  // sound (no eval)
  let soundOn=false, audioCtx=null;
  function beep(freq=880, dur=80, vol=0.06) {
    if (!soundOn) return;
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime, o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type='square'; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination);
      o.start(t0); g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000); o.stop(t0 + dur/1000 + 0.01);
    } catch {}
  }
  $muteBtn.onclick = ()=>{ soundOn=!soundOn; $muteBtn.textContent='Sound: ' + (soundOn? 'On':'Off'); if(soundOn) beep(660,60,0.03); };

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function fit(){ canvas.width=innerWidth; canvas.height=innerHeight; }
  addEventListener('resize', fit, {passive:true}); fit();

  const S={ running:false, over:false, score:0, combo:1, lives:3, best:0, time:0, spawnTimer:0, spawnRate:800, speed:220, coins:[], tp:{ x:innerWidth*0.5, y:innerHeight-90, w:180, h:36 } };

  function reset(){ S.score=0; S.combo=1; S.lives=3; S.coins.length=0; S.time=0; S.spawnTimer=0; S.spawnRate=800; S.speed=220; S.tp.x = canvas.width/2; }
  function start(){ reset(); S.running=true; S.over=false; $start.style.display='none'; $over.style.display='none'; last=performance.now(); requestAnimationFrame(loop); }
  function over(){ S.running=false; S.over=true; S.best=Math.max(S.best,S.score); $final.textContent=`Score: ${S.score} ‚Ä¢ Best: ${S.best}`; $over.style.display='flex';
    // let the leaderboard listen
    window.dispatchEvent(new CustomEvent('wipe:gameover',{detail:{score:S.score,combo:S.combo}}));
  }

  $startBtn.onclick = start; $again.onclick = start;
  $share.onclick = ()=>{
    const text = `I scored ${S.score} in WIPE üßªüí∞ ‚Äî can you beat me? #WIPEcoin`;
    const u = new URL('https://twitter.com/intent/tweet'); u.searchParams.set('text', text); u.searchParams.set('url', location.origin);
    window.open(u.toString(), '_blank');
  };

  // input
  let dragging=false, dragOffset=0;
  canvas.addEventListener('pointerdown', e=>{ dragging=true; dragOffset = clamp(e.clientX - S.tp.x, -S.tp.w/2, S.tp.w/2); });
  addEventListener('pointermove', e=>{ if (!dragging) return; S.tp.x = clamp(e.clientX - dragOffset, S.tp.w/2, canvas.width - S.tp.w/2); });
  addEventListener('pointerup', ()=> dragging=false);
  const keys={}; addEventListener('keydown', e=>keys[e.key]=true); addEventListener('keyup', e=>keys[e.key]=false);

  const rand=(a,b)=>Math.random()*(b-a)+a;

  function spawn(){ const rare = Math.random() < 0.12; S.coins.push({ x: rand(40, canvas.width-40), y: -30, r: rare? 24:18, v: S.speed*(rare?.95:1), type: rare? 'diamond':'gold', rot: rand(0, Math.PI*2) }); }
  function collide(c,tp){ const cx = clamp(c.x, tp.x - tp.w/2, tp.x + tp.w/2); const cy = clamp(c.y, tp.y - tp.h/2, tp.y + tp.h/2); const dx=c.x-cx, dy=c.y-cy; return dx*dx+dy*dy <= c.r*c.r; }

  function drawTP(tp){
    // Prefer the PNG catcher if available
    if(tpImage){
      const scale = tp.h / 36; // keep similar height
      const w = tp.w, h = tp.h;
      ctx.drawImage(tpImage, tp.x - w/2, tp.y - h/2, w, h);
      return;
    }
    // fallback vector style
    const {x,y,w,h}=tp, r=18;
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle='#f1f4f8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.roundRect(-w/2,-h/2,w,h,r); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#b8894d'; ctx.beginPath(); ctx.ellipse(-w*0.35,0,14,14,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(30,78,137,.70)'; ctx.font='900 18px system-ui'; ctx.textAlign='center'; ctx.fillText('WIPE',0,6);
    ctx.restore();
  }

  function drawCoin(c){
    ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rot);
    if (c.type==='diamond' && coinDiamond){
      const s = c.r*2.2; ctx.drawImage(coinDiamond, -s/2, -s/2, s, s);
    } else if (c.type==='gold' && coinGold){
      const s = c.r*2.2; ctx.drawImage(coinGold, -s/2, -s/2, s, s);
    } else {
      // fallback vector coin
      const grad = ctx.createRadialGradient(-5,-5,4,0,0,c.r+6);
      grad.addColorStop(0,'#fff5b2'); grad.addColorStop(1, '#F6C445');
      ctx.fillStyle = grad; ctx.strokeStyle = '#b98513'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(0,0,c.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.fillStyle='#7f5a0a'; ctx.font='bold 14px system-ui'; ctx.textAlign='center'; ctx.fillText('$',0,5);
    }
    ctx.restore();
  }

  // popups + sparkles
  const pops=[];
  function popup(x,y,txt){ pops.push({x,y,txt,t:0}); }
  function drawPops(dt){
    for(let i=pops.length-1;i>=0;i--){
      const p=pops[i]; p.t+=dt; const a=Math.max(0,1-p.t*1.5), y=p.y - p.t*40;
      ctx.globalAlpha=a; ctx.fillStyle='#fff'; ctx.font='900 18px system-ui'; ctx.textAlign='center'; ctx.fillText(p.txt,p.x,y); ctx.globalAlpha=1;
      if(a<=0) pops.splice(i,1);
    }
  }
  const sparkles=[];
  function burst(x,y){
    for(let i=0;i<16;i++){ sparkles.push({x,y,a:Math.random()*Math.PI*2,s:rand(40,120),t:0}); }
  }
  function drawSparkles(dt){
    for(let i=sparkles.length-1;i>=0;i--){
      const s=sparkles[i]; s.t+=dt; const life=0.5, a=Math.max(0,1-s.t/life);
      const x=s.x+Math.cos(s.a)*s.s*s.t, y=s.y+Math.sin(s.a)*s.s*s.t;
      ctx.globalAlpha=a; ctx.fillStyle='#fff'; ctx.fillRect(x,y,2,2); ctx.globalAlpha=1;
      if(a<=0) sparkles.splice(i,1);
    }
  }

  let last=0;
  function loop(t){
    if (!S.running) return;
    const dt = Math.min(32, t-last)/1000; last=t;
    S.time += dt; S.spawnTimer += dt*1000;
    S.speed += dt*6; S.spawnRate = Math.max(260, S.spawnRate - dt*8);
    if (S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawn(); }
    if (keys['ArrowLeft']||keys['a']) S.tp.x -= 420*dt;
    if (keys['ArrowRight']||keys['d']) S.tp.x += 420*dt;
    S.tp.x = clamp(S.tp.x, S.tp.w/2, canvas.width - S.tp.w/2);

    for (let i=S.coins.length-1;i>=0;i--){
      const c = S.coins[i];
      c.y += c.v*dt; c.rot += (c.type==='diamond'?2.2:1.4)*dt;
      if (collide(c,S.tp)){
        const gained=(c.type==='diamond'?100:10) * S.combo; S.score+=gained; popup(c.x,c.y, (c.type==='diamond'?'+100':'+10')); if(c.type==='diamond') burst(c.x,c.y);
        S.combo=Math.min(10,S.combo+1); beep(c.type==='diamond'?1040:820,70);
        S.coins.splice(i,1);
      } else if (c.y - c.r > canvas.height){
        S.lives -= 1; S.combo=1; S.coins.splice(i,1); beep(220,120); if (S.lives<=0) over();
      }
    }

    // draw
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (bgImage) {
      // cover background (center-crop)
      const iw=bgImage.width, ih=bgImage.height, cw=canvas.width, ch=canvas.height;
      const r=Math.max(cw/iw, ch/ih), w=iw*r, h=ih*r, x=(cw-w)/2, y=(ch-h)/2;
      ctx.drawImage(bgImage, x, y, w, h);
    } else {
      // fallback gradient
      const g=ctx.createLinearGradient(0,0,0,canvas.height);
      g.addColorStop(0,'#0E2341'); g.addColorStop(1,'#09172B'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    S.coins.forEach(drawCoin); drawTP(S.tp);
    drawSparkles(dt); drawPops(dt);

    $score.textContent = `Score: ${S.score}`;
    $combo.textContent = `Combo: x${S.combo}`;
    $lives.textContent = `Lives: ${S.lives}`;
    requestAnimationFrame(loop);
  }

  // boot
  preloadAll().then(()=>{}); // start panel stays until user clicks
})();
</script>

<!-- (Optional) minimal leaderboard listener (keeps CSP happy) -->
<script>
  // Example placeholder so the css link doesn't 404 in DevTools if you keep it empty
  // Your real /game/js/leaderboard.css exists now so this is enough for today.
</script>
</body>
</html>
