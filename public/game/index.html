<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIPE: Catch The Gains</title>
<meta name="description" content="WIPE mini-game ‚Äî catch coins with a toilet paper roll and post your score.">
<link rel="icon" href="../assets/favicon.png" type="image/png">

<style>
  :root{
    --bg:#0E2341; --tile:#122b52; --accent:#1E4E89;
    --gold:#F6C445; --text:#F7F7F7;
  }
  html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text)}
  canvas{display:block;width:100%;height:100vh;background:
    url("../assets/backdrop.png") center/cover no-repeat fixed;}

  /* HUD */
  #ui{position:fixed;inset:0;pointer-events:none}
  .hud{position:absolute;left:12px;top:10px;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;gap:12px;align-items:center}
  .brand{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(30,78,137,.28);border:1px solid rgba(255,255,255,.12)}
  .brand img{width:18px;height:18px;border-radius:50%}
  .right{position:absolute;right:12px;top:10px;font-weight:700;opacity:.85}

  /* Panels */
  .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
  .panel{pointer-events:auto;background:rgba(14,35,65,.86);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:20px;max-width:720px;width:min(92%,720px);backdrop-filter:blur(2px)}
  .panel h1{margin:0 0 8px}
  .panel p{margin:8px 0}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  button{pointer-events:auto;cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font-weight:800}
  .primary{background:var(--accent);color:#061b2c}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.25)}
  .backdrop{
    background-image:url("../assets/diamond-panel.png");
    background-size:cover;background-position:center;
    border-radius:14px;min-height:220px;margin-bottom:14px;
  }
  .credits{position:absolute;right:12px;bottom:10px;font-size:12px;opacity:.7}

  /* Floating popups */
  .pop{
    position:absolute;left:0;top:0;transform:translate(-50%,-50%);
    color:#fff;font-weight:900;text-shadow:0 2px 8px rgba(0,0,0,.6);
    pointer-events:none;will-change:transform,opacity;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="ui">
  <div class="hud">
    <span class="brand"><img src="../assets/logo.png" alt="WIPE"><b>WIPE</b></span>
    <span id="score">Score: 0</span>
    <span id="combo">Combo: x1</span>
    <span id="lives">Lives: 3</span>
  </div>
  <div class="right">Drag / Touch or ‚Üê ‚Üí</div>

  <div id="start" class="center">
    <div class="panel">
      <div class="backdrop"></div>
      <h1>WIPE: Catch the Gains üíé</h1>
      <p>Move the TP roll to <b>catch coins</b>. Miss 3 and it‚Äôs <i>game over</i>.</p>
      <div class="actions">
        <button id="startBtn" class="primary">Start</button>
        <button id="muteBtn" class="ghost">Sound: Off</button>
      </div>
    </div>
  </div>

  <div id="gameover" class="center" style="display:none;">
    <div class="panel">
      <h2>Flushed‚Ä¶ üíÄ</h2>
      <p id="final"></p>
      <div class="actions">
        <button id="again" class="primary">Play Again</button>
        <button id="share" class="ghost">Share to X</button>
      </div>
    </div>
  </div>

  <div id="overlay"></div>
  <div class="credits">WIPE mini-game</div>
</div>

<script>
(()=>{

  /*** ---------- SETUP & PRELOAD ---------- ***/
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const $score = document.getElementById('score');
  const $combo = document.getElementById('combo');
  const $lives = document.getElementById('lives');

  const $start = document.getElementById('start');
  const $startBtn = document.getElementById('startBtn');
  const $muteBtn = document.getElementById('muteBtn');

  const $over = document.getElementById('gameover');
  const $final = document.getElementById('final');
  const $again = document.getElementById('again');
  const $share = document.getElementById('share');

  const $overlay = document.getElementById('overlay'); // container for floating DOM popups

  function fit(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', fit, {passive:true}); fit();

  const IMG = {
    gold:        '../assets/coin.png',
    diamond:     '../assets/diamond_coin.png',
    catcher:     '../assets/tp-roll.png'
  };
  const TEX = {};
  function loadImage(src){
    return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; });
  }

  // sound
  let soundOn = false; let audioCtx = null;
  function beep(freq=880, dur=80, vol=0.06) {
    if (!soundOn) return;
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = freq;
      g.gain.value = vol; o.connect(g); g.connect(audioCtx.destination);
      o.start(t0); g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000); o.stop(t0 + dur/1000 + 0.01);
    } catch {}
  }
  $muteBtn.onclick = () => { soundOn = !soundOn; $muteBtn.textContent = 'Sound: ' + (soundOn ? 'On':'Off'); if (soundOn) beep(660,60,0.03); };

  /*** ---------- GAME STATE ---------- ***/
  const S = {
    running:false, over:false,
    score:0, combo:1, lives:3, best:0,
    time:0, spawnTimer:0, spawnRate:850, speed:240,
    coins:[], particles:[], popups:[],
    tp:{ x:innerWidth*0.5, y:innerHeight-90, w:180, h:54 },
    shakeT:0, shakeA:0
  };

  // helpers
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  function spawn(){
    const rare = Math.random() < 0.14; // ~14% diamond
    S.coins.push({
      x: rand(50, canvas.width-50),
      y: -40,
      r: rare ? 26 : 22,
      v: S.speed*(rare?.97:1),
      type: rare ? 'diamond':'gold',
      rot: rand(0, Math.PI*2),
      rotSpeed: rand(-1,1)*0.6
    });
  }

  function collide(circle, tp){
    const cx = clamp(circle.x, tp.x - tp.w/2, tp.x + tp.w/2);
    const cy = clamp(circle.y, tp.y - tp.h/2, tp.y + tp.h/2);
    const dx=circle.x-cx, dy=circle.y-cy;
    return dx*dx+dy*dy <= circle.r*circle.r;
  }

  function emitSparkles(x,y, n=16){
    for(let i=0;i<n;i++){
      S.particles.push({
        x,y,
        vx: rand(-120,120),
        vy: rand(-180,-40),
        life: rand(.4,.8),
        t:0,
        s: rand(3,6),
        type:'spark'
      });
    }
  }

  function makePopup(x,y, txt, color){
    const el = document.createElement('div');
    el.className='pop';
    el.textContent = txt;
    el.style.color = color;
    el.style.fontSize = '20px';
    $overlay.appendChild(el);
    S.popups.push({el,x,y,t:0,life:0.9});
  }

  function screenShake(amount=10, time=.25){
    S.shakeA = amount;
    S.shakeT = time;
  }

  function reset(){
    S.score=0; S.combo=1; S.lives=3; S.coins.length=0; S.particles.length=0; S.popups.forEach(p=>p.el.remove()); S.popups.length=0;
    S.time=0; S.spawnTimer=0; S.spawnRate=850; S.speed=240;
    S.tp.x = canvas.width/2;
  }
  function start(){ reset(); S.running=true; S.over=false; $start.style.display='none'; $over.style.display='none'; last=performance.now(); requestAnimationFrame(loop); }
  function over(){
    S.running=false; S.over=true; S.best=Math.max(S.best,S.score);
    $final.textContent = `Score: ${S.score}  ‚Ä¢  Best: ${S.best}`;
    $over.style.display='flex';
  }

  $startBtn.onclick = start; $again.onclick = start;
  $share.onclick = () => {
    const text = `I scored ${S.score} in WIPE: Catch the Gains üßªüí∞ ‚Äî can you beat me? #WIPEcoin`;
    const url = location.origin + location.pathname.replace('/game/index.html','') || location.href;
    const u = new URL('https://twitter.com/intent/tweet'); u.searchParams.set('text', text); u.searchParams.set('url', url); window.open(u.toString(), '_blank');
  };

  // input
  let dragging=false, dragOffset=0;
  canvas.addEventListener('pointerdown', e=>{ dragging=true; dragOffset = clamp(e.clientX - S.tp.x, -S.tp.w/2, S.tp.w/2); });
  addEventListener('pointermove', e=>{ if (!dragging) return; S.tp.x = clamp(e.clientX - dragOffset, S.tp.w/2, canvas.width - S.tp.w/2); });
  addEventListener('pointerup', ()=> dragging=false);
  const keys={}; addEventListener('keydown', e=>keys[e.key]=true); addEventListener('keyup', e=>keys[e.key]=false);

  /*** ---------- DRAW ---------- ***/
  function drawTP(tp){
    const iw = TEX.catcher.width, ih = TEX.catcher.height;
    const w = tp.w, h = tp.h;
    ctx.save();
    ctx.translate(tp.x, tp.y);
    ctx.drawImage(TEX.catcher, -w/2, -h/2, w, h);
    ctx.restore();
  }
  function drawCoin(c){
    ctx.save();
    ctx.translate(c.x,c.y);
    ctx.rotate(c.rot);
    const tex = c.type==='diamond' ? TEX.diamond : TEX.gold;
    const size = c.r*2.2;
    ctx.drawImage(tex, -size/2, -size/2, size, size);
    ctx.restore();
  }
  function drawParticle(p){
    if(p.type==='spark'){
      const t = p.t / p.life;
      ctx.globalAlpha = 1-Math.min(1,t);
      ctx.fillStyle = t<.5 ? '#ffffff' : '#a7d0ff';
      ctx.beginPath(); ctx.arc(p.x,p.y,p.s*(1-t),0,Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  /*** ---------- LOOP ---------- ***/
  let last=0;
  function loop(t){
    if (!S.running) return;
    const dt = Math.min(32, t-last)/1000; last=t;
    S.time += dt; S.spawnTimer += dt*1000;

    // difficulty
    S.speed += dt*8; S.spawnRate = Math.max(260, S.spawnRate - dt*9);
    if (S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawn(); }

    // input
    if (keys['ArrowLeft']||keys['a']) S.tp.x -= 460*dt;
    if (keys['ArrowRight']||keys['d']) S.tp.x += 460*dt;
    S.tp.x = clamp(S.tp.x, S.tp.w/2, canvas.width - S.tp.w/2);

    // update coins
    for (let i=S.coins.length-1;i>=0;i--){
      const c = S.coins[i];
      c.y += c.v*dt; c.rot += c.rotSpeed*dt;
      if (collide(c,S.tp)){
        const val = (c.type==='diamond'?100:10) * S.combo;
        S.score += val; S.combo = Math.min(10, S.combo+1);
        makePopup(c.x, c.y-18, `+${val}`, c.type==='diamond' ? '#6fd6ff' : '#ffd85e');
        if (c.type==='diamond'){ emitSparkles(c.x,c.y,18); screenShake(12,.28); beep(1200,90,0.06); }
        else { beep(820,65,0.045); }
        S.coins.splice(i,1);
      } else if (c.y - c.r > canvas.height){
        S.lives -= 1; S.combo=1; S.coins.splice(i,1);
        beep(220,140,0.06);
        if (S.lives<=0) { over(); }
      }
    }

    // update particles
    for(let i=S.particles.length-1;i>=0;i--){
      const p = S.particles[i];
      p.t += dt; if (p.t>=p.life){ S.particles.splice(i,1); continue; }
      p.vy += 420*dt; p.x += p.vx*dt; p.y += p.vy*dt;
    }

    // update DOM popups
    for(let i=S.popups.length-1;i>=0;i--){
      const pp = S.popups[i];
      pp.t += dt; const k = pp.t/pp.life; if (k>=1){ pp.el.remove(); S.popups.splice(i,1); continue; }
      const y = pp.y - 40*k; const x = pp.x;
      pp.el.style.opacity = String(1-k);
      pp.el.style.transform = `translate(${x}px, ${y}px) translate(-50%,-50%)`;
    }

    // draw
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // screen shake
    if (S.shakeT>0){
      S.shakeT -= dt;
      const a = S.shakeA * (S.shakeT>0 ? S.shakeT : 0);
      ctx.save();
      ctx.translate(rand(-a,a), rand(-a,a));
      S.coins.forEach(drawCoin);
      drawTP(S.tp);
      S.particles.forEach(drawParticle);
      ctx.restore();
    } else {
      S.coins.forEach(drawCoin);
      drawTP(S.tp);
      S.particles.forEach(drawParticle);
    }

    // HUD text
    $score.textContent = `Score: ${S.score}`;
    $combo.textContent = `Combo: x${S.combo}`;
    $lives.textContent = `Lives: ${S.lives}`;

    requestAnimationFrame(loop);
  }

  /*** ---------- BOOT ---------- ***/
  Promise.all([
    loadImage(IMG.gold).then(i=>TEX.gold=i),
    loadImage(IMG.diamond).then(i=>TEX.diamond=i),
    loadImage(IMG.catcher).then(i=>TEX.catcher=i),
  ]).catch(e=>console.error('Image load error', e));

})();
</script>
</body>
</html>
