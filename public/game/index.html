<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIPE: Catch The Gains</title>
<link rel="icon" href="/game/assets/favicon.png" type="image/png">

<style>
  :root{
    --bg:#0E2341; --tile:#122b52; --accent:#1E4E89;
    --gold:#F6C445; --text:#F7F7F7;
  }
  html,body{margin:0;height:100%;overflow:hidden;background:#0E2341;color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  canvas{display:block;width:100vw;height:100vh}

  /* ---------- phase backgrounds ---------- */
  /* BEFORE start: big promo card centered, always visible */
  body.prestart{
    background-color:#0E2341;
    background-image:url("/game/assets/start-panel.png");
    background-repeat:no-repeat;
    background-position:center 110px;
    background-size:min(640px, 86vw);
  }
  @media (max-width:600px){
    body.prestart{ background-position:center 72px; }
  }

  /* DURING game: tasteful poster background, not ‚Äúzoomed-in‚Äù on phones */
  body.playing{
    background-color:#0E2341;
    background-image:url("/game/assets/background.png");
    background-repeat:no-repeat;
    background-position:center top;
    /* cap the visual size so it doesn‚Äôt look gigantic on mobile */
    background-size:1200px auto;
    background-attachment:fixed;
  }
  @media (max-width:900px){
    body.playing{
      background-size:760px auto;      /* smaller on phones */
      background-position:center -40px; /* nudge up a bit */
    }
  }

  /* ---------- HUD / panels ---------- */
  #ui{position:fixed;inset:0;pointer-events:none}
  .hud{position:absolute;left:10px;top:8px;display:flex;gap:12px;align-items:center;
       font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.35)}
  .brand{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;
         background:rgba(30,78,137,.28);border:1px solid rgba(255,255,255,.12)}
  .brand img{width:18px;height:18px;border-radius:50%}

  .right{position:absolute;right:12px;top:10px;opacity:.85;font-weight:700}

  .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .panel{pointer-events:auto;background:rgba(14,35,65,.92);border:1px solid rgba(255,255,255,.12);
         border-radius:18px;padding:22px;max-width:760px;width:min(92vw,760px);
         box-shadow:0 10px 40px rgba(0,0,0,.35)}
  .hero{
    width:100%; height:auto; display:block;
    background:rgba(255,255,255,.02);
    border-radius:12px; border:1px solid rgba(255,255,255,.08);
  }

  h1{margin:10px 6px 8px;font-size:clamp(22px,3.6vw,32px)}
  .muted{opacity:.85}

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{pointer-events:auto;cursor:pointer;border:0;border-radius:12px;
         padding:12px 18px;font-weight:800}
  .primary{background:var(--accent);color:#061b2c}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.25)}

  .credits{position:absolute;right:10px;bottom:8px;opacity:.7;font-size:12px}
</style>
</head>
<body class="prestart">
<canvas id="game"></canvas>

<div id="ui">
  <div class="hud">
    <span class="brand"><img src="/game/assets/logo.png" alt=""><b>WIPE</b></span>
    <span id="score">Score: 0</span>
    <span id="combo">Combo: x1</span>
    <span id="lives">Lives: 3</span>
  </div>
  <div class="right">Drag / Touch or ‚Üê ‚Üí</div>

  <!-- START PANEL -->
  <div id="start" class="center">
    <div class="panel" role="dialog" aria-label="Start Game">
      <img class="hero" src="/game/assets/start-panel.png"
           alt="Flush your debt, catch the gains!">
      <h1>WIPE: Catch the Gains üíé</h1>
      <p class="muted">Move the TP roll to <b>catch coins</b>. Miss 3 and it‚Äôs <i>game over</i>.</p>
      <div class="actions">
        <button id="startBtn" class="primary">Start</button>
        <button id="muteBtn" class="ghost">Sound: Off</button>
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="over" class="center" style="display:none;">
    <div class="panel" role="dialog" aria-label="Game Over">
      <h1>Flushed‚Ä¶ üíÄ</h1>
      <p id="final" class="muted"></p>
      <div class="actions">
        <button id="again" class="primary">Play Again</button>
        <button id="share" class="ghost">Share to X</button>
      </div>
    </div>
  </div>

  <div class="credits">WIPE mini-game</div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const ui = {
    score: document.getElementById('score'),
    combo: document.getElementById('combo'),
    lives: document.getElementById('lives'),
    start: document.getElementById('start'),
    startBtn: document.getElementById('startBtn'),
    muteBtn: document.getElementById('muteBtn'),
    over: document.getElementById('over'),
    final: document.getElementById('final'),
    again: document.getElementById('again'),
    share: document.getElementById('share'),
  };

  // ---------- SOUND ----------
  let soundOn = false, audioCtx = null;
  function beep(freq=880, dur=80, vol=0.06){
    if (!soundOn) return;
    try{
      audioCtx ||= new (window.AudioContext||window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g  = audioCtx.createGain();
      osc.type = 'square'; osc.frequency.value = freq;
      g.gain.value = vol; osc.connect(g); g.connect(audioCtx.destination);
      osc.start(t0); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur/1000);
      osc.stop(t0 + dur/1000 + 0.01);
    }catch{}
  }
  ui.muteBtn.onclick = () => {
    soundOn = !soundOn;
    ui.muteBtn.textContent = 'Sound: ' + (soundOn ? 'On' : 'Off');
    if (soundOn) beep(720,70,0.03);
  };

  // ---------- ASSETS ----------
  // All paths are under /game/assets to avoid 404s
  const IMAGES = {
    tp: '/game/assets/tp-roll.png',
    coin: '/game/assets/coin_gold.png',
    diamond: '/game/assets/coin_diamond.png'
  };
  const img = {};
  function loadImage(key){
    return new Promise(resolve=>{
      const el = new Image();
      el.onload = ()=> resolve(img[key] = el);
      el.onerror = ()=> resolve(img[key] = null);
      el.src = IMAGES[key];
    });
  }

  // ---------- STATE ----------
  const S = {
    running:false, over:false,
    score:0, combo:1, lives:3, best:0,
    coins:[], particles:[], popups:[],
    spawnTimer:0, spawnRate:850, speed:220,
    tp: { x:0, y:0, w:180, h:40 }, // responsive width set in tpSize()
  };

  function fit(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
    tpSize();
    S.tp.y = canvas.height - Math.round(S.tp.h*1.6);
    if (!S.running) S.tp.x = canvas.width/2;
  }
  addEventListener('resize', fit, {passive:true}); fit();

  // Make TP size adaptive: smaller on phones, larger on desktop.
  function tpSize(){
    const v = Math.min(innerWidth, innerHeight);
    const w = Math.max(90, Math.min(220, Math.round(v*0.22))); // 22% of vmin, clamped
    S.tp.w = w;
    S.tp.h = Math.round(w*0.22);
  }

  function reset(){
    S.score=0; S.combo=1; S.lives=3;
    S.coins.length=0; S.particles.length=0; S.popups.length=0;
    S.spawnTimer=0; S.spawnRate=850; S.speed=220;
    tpSize(); S.tp.x = canvas.width/2; S.tp.y = canvas.height - Math.round(S.tp.h*1.6);
    ui.score.textContent = 'Score: 0';
    ui.combo.textContent = 'Combo: x1';
    ui.lives.textContent = 'Lives: 3';
  }

  function start(){
    document.body.classList.remove('prestart');
    document.body.classList.add('playing');
    reset(); S.running=true; S.over=false;
    ui.start.style.display='none'; ui.over.style.display='none';
    last = performance.now(); requestAnimationFrame(loop);
  }
  function gameOver(){
    S.running=false; S.over=true;
    S.best = Math.max(S.best, S.score);
    ui.final.textContent = `Score: ${S.score} ‚Ä¢ Best: ${S.best}`;
    ui.over.style.display='flex';
    document.body.classList.remove('playing');
    document.body.classList.add('prestart'); // show nice poster again
  }

  ui.startBtn.onclick = start;
  ui.again.onclick = start;
  ui.share.onclick = () => {
    const t = `I scored ${S.score} in WIPE: Catch the Gains üßªüí∞ ‚Äî can you beat me? #WIPEcoin`;
    const u = new URL('https://twitter.com/intent/tweet');
    u.searchParams.set('text', t); u.searchParams.set('url', location.href);
    open(u.toString(),'_blank');
  };

  // ---------- INPUT ----------
  let dragging=false, dragOffset=0;
  canvas.addEventListener('pointerdown', e => {
    dragging = true;
    dragOffset = Math.max(-S.tp.w/2, Math.min(S.tp.w/2, e.clientX - S.tp.x));
  });
  addEventListener('pointermove', e => {
    if (!dragging) return;
    S.tp.x = Math.max(S.tp.w/2, Math.min(canvas.width - S.tp.w/2, e.clientX - dragOffset));
  });
  addEventListener('pointerup', ()=> dragging=false);
  const keys={}; addEventListener('keydown', e=>keys[e.key]=true);
  addEventListener('keyup',   e=>keys[e.key]=false);

  // ---------- COINS & FX ----------
  const rnd = (a,b)=>Math.random()*(b-a)+a;
  function spawn(){
    const rare = Math.random() < 0.12;
    S.coins.push({
      x: rnd(34, canvas.width-34),
      y: -28,
      r: rare ? 24 : 18,
      v: S.speed * (rare ? 0.96 : 1),
      type: rare ? 'diamond' : 'coin',
      rot: rnd(0,Math.PI*2)
    });
  }
  function collide(c,tp){
    const cx = Math.max(tp.x-tp.w/2, Math.min(tp.x+tp.w/2, c.x));
    const cy = Math.max(tp.y-tp.h/2, Math.min(tp.y+tp.h/2, c.y));
    const dx=c.x-cx, dy=c.y-cy;
    return dx*dx+dy*dy <= c.r*c.r;
  }

  function addPopup(x,y,text,clr){
    // render as particles text so we removed the old popup() function that caused a syntax error
    S.particles.push({x,y, vx:0, vy:-28, life:0.9, text, clr});
  }

  function spark(x,y,good=true){
    for(let i=0;i<(good?16:8);i++){
      S.particles.push({
        x,y, vx:rnd(-2.2,2.2), vy:rnd(-2.0,-0.2),
        life: rnd(0.45,0.9), text:null, clr: good?'#fff':'#f88'
      });
    }
  }

  function drawParticles(dt){
    ctx.save();
    for(let i=S.particles.length-1;i>=0;i--){
      const p = S.particles[i];
      p.life -= dt; p.x += p.vx*60*dt; p.y += p.vy*60*dt;
      if (p.life<=0){ S.particles.splice(i,1); continue; }
      ctx.globalAlpha = Math.max(0, Math.min(1,p.life));
      if (p.text){
        ctx.font='bold 16px system-ui'; ctx.textAlign='center';
        ctx.fillStyle = p.clr || '#fff'; ctx.fillText(p.text, p.x, p.y);
      }else{
        ctx.fillStyle = p.clr || '#fff'; ctx.fillRect(p.x, p.y, 2, 2);
      }
    }
    ctx.restore();
  }

  // ---------- DRAW ----------
  function drawTP(tp){
    if (img.tp){
      const w = tp.w, h = Math.max(tp.h, img.tp.height*(w/img.tp.width)*0.5);
      ctx.drawImage(img.tp, tp.x - w/2, tp.y - h/2, w, h);
    }else{
      // fallback rounded pill
      const r=18; ctx.fillStyle='#f1f4f8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2;
      ctx.beginPath();
      ctx.roundRect(tp.x-tp.w/2, tp.y-tp.h/2, tp.w, tp.h, r);
      ctx.fill(); ctx.stroke();
    }
  }
  function drawCoin(c){
    ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rot);
    const source = (c.type==='diamond') ? img.diamond : img.coin;
    if (source){
      const d = c.r*2;
      ctx.drawImage(source, -d/2, -d/2, d, d);
    }else{
      // simple vector backup
      ctx.fillStyle = (c.type==='diamond') ? '#b6f0ff' : '#F6C445';
      ctx.beginPath(); ctx.arc(0,0,c.r,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  // ---------- GAME LOOP ----------
  let last=0;
  function loop(t){
    if (!S.running) return;
    const dt = Math.min(32, t-last)/1000; last=t;

    // movement
    if (keys['ArrowLeft']||keys['a'])  S.tp.x -= 400*dt;
    if (keys['ArrowRight']||keys['d']) S.tp.x += 400*dt;
    S.tp.x = Math.max(S.tp.w/2, Math.min(canvas.width - S.tp.w/2, S.tp.x));

    // difficulty
    S.speed += dt*6; S.spawnRate = Math.max(260, S.spawnRate - dt*8);
    S.spawnTimer += dt*1000;
    if (S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawn(); }

    // coins
    for (let i=S.coins.length-1;i>=0;i--){
      const c = S.coins[i]; c.y += c.v*dt; c.rot += (c.type==='diamond'?2.0:1.3)*dt;
      if (collide(c,S.tp)){
        const gained = (c.type==='diamond'?100:10) * S.combo;
        S.score += gained; S.combo = Math.min(10, S.combo+1);
        addPopup(c.x,c.y, '+'+gained, c.type==='diamond' ? '#8de1ff':'#fff1a6');
        spark(c.x,c.y,true); if (soundOn) beep(c.type==='diamond'?1040:820,70);
        S.coins.splice(i,1);
      }else if (c.y - c.r > canvas.height){
        S.lives -= 1; S.combo = 1; addPopup(c.x, canvas.height-60, 'MISS','rgba(255,120,120,.95)');
        spark(c.x, canvas.height-30, false);
        S.coins.splice(i,1);
        if (soundOn) beep(220,120);
        if (S.lives<=0) return gameOver();
      }
    }

    // paint
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // subtle ground line
    ctx.fillStyle='rgba(0,0,0,.16)'; ctx.fillRect(0, canvas.height-6, canvas.width, 6);
    // coins / tp / fx
    for (const c of S.coins) drawCoin(c);
    drawTP(S.tp);
    drawParticles(dt);

    // HUD text
    ui.score.textContent = 'Score: ' + S.score;
    ui.combo.textContent = 'Combo: x' + S.combo;
    ui.lives.textContent = 'Lives: ' + S.lives;

    requestAnimationFrame(loop);
  }

  // ---------- BOOT ----------
  Promise.all([loadImage('tp'), loadImage('coin'), loadImage('diamond')])
    .then(()=>{ /* ready */ });
})();
</script>
</body>
</html>
