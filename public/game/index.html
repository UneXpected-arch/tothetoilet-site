<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>WIPE: Catch the Gains</title>
<link rel="icon" href="/game/assets/favicon.png" type="image/png"/>

<style>
  :root{
    --bg:#0E2341; --accent:#1E4E89; --text:#F7F7F7;
  }

  /* Own the viewport & stop page scroll/zoom during play */
  html,body{
    height:100dvh; margin:0; overflow:hidden;
    background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    -webkit-user-select:none; user-select:none;
    touch-action:none; overscroll-behavior:none;
  }

  #game{
    display:block; width:100vw; height:100dvh;
    background:#0E2341; touch-action:none;
  }

  #ui{ position:fixed; inset:0; pointer-events:none }
  .hud{position:absolute;left:12px;top:10px;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;gap:12px;align-items:center}
  .brand{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(30,78,137,.28);border:1px solid rgba(255,255,255,.12)}
  .brand img{width:18px;height:18px;border-radius:50%}
  .right{position:absolute;right:12px;top:10px;font-weight:700;opacity:.85}

  /* Center panels */
  .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .panel{
    pointer-events:auto;
    width:min(900px,92vw);
    border-radius:18px; overflow:hidden;
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 10px 40px rgba(0,0,0,.35);
    color:#fff; background:#0A1C33;
  }
  /* HERO strip that swaps by device */
  .hero{
    width:100%; aspect-ratio:16/9; min-height:180px;
    background:url("/game/assets/start-hero-desktop.png") center/cover no-repeat;
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  @media (max-width:640px){
    .hero{ background-image:url("/game/assets/start-hero-mobile.png"); }
    #start.center, #gameover.center{ align-items:flex-start; padding-top:14px; }
    .panel{ width:94vw; }
  }

  .panel-body{ padding:18px 18px 22px }
  .panel h1{ margin:0 0 6px; font-size:clamp(22px,3.6vw,28px) }
  .panel p{ margin:8px 0; opacity:.92 }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
  button{ cursor:pointer; pointer-events:auto; border:0; border-radius:12px; padding:12px 18px; font-weight:800 }
  .primary{ background:var(--accent); color:#061b2c }
  .ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.25) }

  .credits{position:absolute;right:12px;bottom:10px;font-size:12px;opacity:.7}
</style>
</head>
<body>
  <canvas id="game"></canvas>

  <div id="ui">
    <div class="hud">
      <span class="brand"><img src="/game/assets/logo.png" alt="WIPE"><b>WIPE</b></span>
      <span id="score">Score: 0</span>
      <span id="combo">Combo: x1</span>
      <span id="lives">Lives: 3</span>
    </div>
    <div class="right">Drag / Touch or ‚Üê ‚Üí</div>

    <!-- START -->
    <div id="start" class="center">
      <div class="panel">
        <div class="hero"></div>
        <div class="panel-body">
          <h1>WIPE: Catch the Gains üíé</h1>
          <p>Move the TP roll to <b>catch coins</b>. Miss 3 and it‚Äôs <i>game over</i>.</p>
          <div class="actions">
            <button id="startBtn" class="primary">Start</button>
            <button id="muteBtn"  class="ghost">Sound: Off</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameover" class="center" style="display:none;">
      <div class="panel">
        <div class="hero"></div>
        <div class="panel-body">
          <h2 style="margin:0 0 6px">Flushed‚Ä¶ üíÄ</h2>
          <p id="final" style="margin:8px 0 12px"></p>
          <div class="actions">
            <button id="again" class="primary">Play Again</button>
            <button id="share" class="ghost">Share to X</button>
          </div>
        </div>
      </div>
    </div>

    <div class="credits">WIPE mini-game</div>
  </div>

<script>
(()=>{
  /* ====== Assets (all under /game/assets) ====== */
  const ASSET = {
    heroDesktop: "/game/assets/start-hero-desktop.png",
    heroMobile:  "/game/assets/start-hero-mobile.png",
    bgDesktop:   "/game/assets/bg-desktop.jpg",
    bgMobile:    "/game/assets/bg-mobile.jpg",
    coinGold:    "/game/assets/coin_gold.png",
    coinDia:     "/game/assets/coin_diamond.png",
    tp:          "/game/assets/tp-roll.png"
  };
  const isMobile = () => window.innerWidth <= 640;

  // Preload images
  const IMG = {};
  for (const [k,src] of Object.entries(ASSET)){
    const im = new Image(); im.src = src; IMG[k]=im;
  }

  // DOM
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const $score = document.getElementById('score');
  const $combo = document.getElementById('combo');
  const $lives = document.getElementById('lives');
  const $start = document.getElementById('start');
  const $startBtn = document.getElementById('startBtn');
  const $muteBtn = document.getElementById('muteBtn');
  const $over = document.getElementById('gameover');
  const $final = document.getElementById('final');
  const $again = document.getElementById('again');
  const $share = document.getElementById('share');

  // Touch/gesture lock (no page scroll/zoom while playing)
  const stop = e => e.preventDefault();
  document.addEventListener('touchmove', stop, {passive:false});
  document.addEventListener('gesturestart', stop, {passive:false});
  document.addEventListener('gesturechange', stop, {passive:false});
  document.addEventListener('gestureend', stop, {passive:false});

  // Canvas fit to CSS pixels with DPR transform
  function fitCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const w = window.innerWidth, h = window.innerHeight;
    canvas.width  = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w+'px'; canvas.style.height = h+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    // background choice by device
    BG_IMG = isMobile() ? IMG.bgMobile : IMG.bgDesktop;
    TP_SCALE = isMobile() ? 0.7 : 0.85;     // smaller on mobile
    COIN_SCALE = isMobile() ? 0.75 : 0.9;
  }
  let BG_IMG = IMG.bgDesktop;
  let TP_SCALE = 0.85, COIN_SCALE=0.9;
  window.addEventListener('resize', fitCanvas);
  fitCanvas();

  // Game state
  const S = {
    running:false, over:false,
    score:0, combo:1, lives:3, best:0,
    time:0, spawnTimer:0, spawnRate:900, speed:220,
    coins:[],
    tp:{ x:innerWidth*0.5, y:innerHeight-80, w:140, h:60 }
  };

  function reset(){
    S.score=0; S.combo=1; S.lives=3; S.coins.length=0;
    S.time=0; S.spawnTimer=0; S.spawnRate=900; S.speed=220;
    S.tp.x = canvas.clientWidth/2;
  }
  function start(){
    reset(); S.running=true; S.over=false;
    $start.style.display='none'; $over.style.display='none';
    last=performance.now(); requestAnimationFrame(loop);
  }
  function over(){
    S.running=false; S.over=true;
    S.best = Math.max(S.best, S.score);
    $final.textContent = `Score: ${S.score} ‚Ä¢ Best: ${S.best}`;
    $over.style.display='flex';
  }

  $startBtn.onclick = start; $again.onclick = start;
  $share.onclick = ()=> {
    const u = new URL('https://twitter.com/intent/tweet');
    u.searchParams.set('text', `I scored ${S.score} in WIPE ‚Äî can you beat me? #WIPEcoin`);
    u.searchParams.set('url', location.href);
    window.open(u.toString(), '_blank');
  };

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  let dragging=false, dragOffset=0;
  canvas.addEventListener('pointerdown', e=>{
    dragging=true; dragOffset = clamp(e.clientX - S.tp.x, -S.tp.w/2, S.tp.w/2);
  });
  addEventListener('pointermove', e=>{
    if (!dragging) return;
    S.tp.x = clamp(e.clientX - dragOffset, S.tp.w/2, canvas.clientWidth - S.tp.w/2);
  });
  addEventListener('pointerup', ()=> dragging=false);
  const keys={}; addEventListener('keydown', e=>keys[e.key]=true); addEventListener('keyup', e=>keys[e.key]=false);

  // Spawning & drawing
  function spawn(){
    const rare = Math.random() < 0.08;
    const img  = rare ? IMG.coinDia : IMG.coinGold;
    S.coins.push({
      x: Math.random()*(canvas.clientWidth-80)+40,
      y: -30,
      r: rare ? 28 : 22,
      v: S.speed*(rare?.95:1),
      type: rare? 'diamond':'gold',
      rot: Math.random()*Math.PI*2,
      img
    });
  }

  function drawBgCover(img){
    if (!img || !img.complete) return;
    const W = canvas.clientWidth, H = canvas.clientHeight;
    const iw = img.naturalWidth, ih = img.naturalHeight;
    if (!iw || !ih) return;
    const s = Math.max(W/iw, H/ih);
    const dw = iw*s, dh = ih*s;
    const dx = (W - dw)/2, dy = (H - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function drawTP(){
    const img = IMG.tp;
    const baseW = 180, baseH = 140;
    const w = baseW*TP_SCALE, h = baseH*TP_SCALE;
    S.tp.w = w; S.tp.h = h*0.55;            // hitbox lower than graphic
    const x = S.tp.x - w/2, y = canvas.clientHeight - h - 10;
    S.tp.y = y + h*0.65;                     // hitbox center
    if (img && img.complete) ctx.drawImage(img, x, y, w, h);
    else { // fallback shape
      ctx.fillStyle='#f1f4f8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.roundRect(S.tp.x - S.tp.w/2, S.tp.y - S.tp.h/2, S.tp.w, S.tp.h, 16); ctx.fill(); ctx.stroke();
    }
  }

  function drawCoin(c){
    const scale = COIN_SCALE;
    const size = c.r*2*scale;
    if (c.img && c.img.complete){
      ctx.save();
      ctx.translate(c.x, c.y); ctx.rotate(c.rot);
      ctx.drawImage(c.img, -size/2, -size/2, size, size);
      ctx.restore();
    } else {
      ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rot);
      ctx.fillStyle = c.type==='diamond' ? '#b6f0ff' : '#F6C445';
      ctx.beginPath(); ctx.arc(0,0,c.r,0,Math.PI*2); ctx.fill(); ctx.restore();
    }
  }

  function collide(c,tp){
    const cx = clamp(c.x, tp.x - tp.w/2, tp.x + tp.w/2);
    const cy = clamp(c.y, tp.y - tp.h/2, tp.y + tp.h/2);
    const dx=c.x-cx, dy=c.y-cy;
    return dx*dx+dy*dy <= (c.r*0.85)*(c.r*0.85);
  }

  // Loop
  let last = 0;
  function loop(t){
    if (!S.running) return;
    const dt = Math.min(32, t-last)/1000; last=t;

    S.time += dt; S.spawnTimer += dt*1000;
    S.speed += dt*6; S.spawnRate = Math.max(280, S.spawnRate - dt*8);
    if (S.spawnTimer > S.spawnRate){ S.spawnTimer = 0; spawn(); }

    if (keys['ArrowLeft']||keys['a'])  S.tp.x -= 420*dt;
    if (keys['ArrowRight']||keys['d']) S.tp.x += 420*dt;
    S.tp.x = clamp(S.tp.x, S.tp.w/2, canvas.clientWidth - S.tp.w/2);

    for (let i=S.coins.length-1;i>=0;i--){
      const c=S.coins[i];
      c.y += c.v*dt; c.rot += (c.type==='diamond'?2.1:1.5)*dt;
      if (collide(c,S.tp)){ const gained=(c.type==='diamond'?100:10)*S.combo; S.score+=gained; S.combo=Math.min(10,S.combo+1); S.coins.splice(i,1); }
      else if (c.y - c.r > canvas.clientHeight){ S.lives -= 1; S.combo=1; S.coins.splice(i,1); if (S.lives<=0) over(); }
    }

    // DRAW
    drawBgCover(BG_IMG);
    S.coins.forEach(drawCoin);
    drawTP();

    $score.textContent = `Score: ${S.score}`;
    $combo.textContent = `Combo: x${S.combo}`;
    $lives.textContent = `Lives: ${S.lives}`;

    requestAnimationFrame(loop);
  }

  // Kickoff
  // Ensure correct bg and scales on orientation changes
  window.addEventListener('orientationchange', ()=> setTimeout(()=>fitCanvas(), 220));
})();
</script>
</body>
</html>
